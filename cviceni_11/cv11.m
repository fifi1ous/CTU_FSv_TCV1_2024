clc; clear; format long G
%%
%   i  x      y       z
data=[ 1 2.908  2.863  3.396 
    2 2.891  5.787  3.521 
    3 2.915  8.689  3.562 
    4 2.892  11.580  3.845 
    5 2.901  14.491  3.823 
    6 2.950  17.401  3.950 
    7 2.934  20.304  4.059 
    8 2.912  23.245  4.158 
    9 5.802  2.885  3.667 
   10 5.836  5.803  3.726 
   11 5.798  8.686  3.929 
   12 5.834  11.608  4.061 
   13 5.790  14.497  4.038 
   14 5.781  17.385  4.292 
   15 5.765  20.273  4.225 
   16 5.812  23.215  4.352 
   17 8.715  2.935  3.853 
   18 8.706  5.821  3.994 
   19 8.655  8.688  4.156 
   20 8.706  11.586  4.277 
   21 8.681  14.482  4.308 
   22 8.699  17.417  4.397 
   23 8.710  20.311  4.650 
   24 8.717  23.240  4.737 
   25 11.593  2.897  4.178 
   26 11.606  5.825  4.293 
   27 11.611  8.687  4.366 
   28 11.569  11.596  4.421 
   29 11.546  14.510  4.647 
   30 11.624  17.392  4.725 
   31 11.577  20.310  4.929 
   32 11.616  23.191  4.969 
   33 14.509  2.911  4.414 
   34 14.491  5.824  4.441 
   35 14.477  8.682  4.568 
   36 14.480  11.614  4.755 
   37 14.496  14.489  4.892 
   38 14.493  17.415  4.990 
   39 14.494  20.301  5.095 
   40 14.502  23.206  5.217 
   41 17.374  2.875  4.628 
   42 17.391  5.805  4.835 
   43 17.412  8.695  4.968 
   44 17.378  11.600  5.026 
   45 17.402  14.514  5.195 
   46 17.363  17.412  5.240 
   47 17.390  20.274  5.318 
   48 17.396  23.192  5.542 
   49 20.286  2.899  4.951 
   50 20.304  5.812  5.002 
   51 20.282  8.713  5.246 
   52 20.326  11.577  5.283 
   53 20.265  14.503  5.411 
   54 20.291  17.425  5.550 
   55 20.293  20.268  5.708 
   56 20.296  23.184  5.776 
   57 23.190  2.921  5.225 
   58 23.180  5.803  5.271 
   59 23.189  8.667  5.425 
   60 23.178  11.593  5.515 
   61 23.232  14.521  5.688 
   62 23.222  17.381  5.785 
   63 23.196  20.273  5.886 
   64 23.227  23.183  6.044 
   65 26.140  2.900  5.390 
   66 26.081  5.784  5.584 
   67 26.068  8.723  5.673 
   68 26.100  11.614  5.797 
   69 26.088  14.509  5.929 
   70 26.112  17.424  6.009 
   71 26.108  20.308  6.168 
   72 26.102  23.220  6.338 
   73 28.997  2.906  5.753 
   74 28.995  5.779  5.843 
   75 28.952  8.714  5.978 
   76 29.008  11.602  6.084 
   77 28.998  14.524  6.376 
   78 28.994  17.399  6.339 
   79 28.978  20.296  6.393 
   80 29.015  23.182  6.611 
   81 31.915  2.871  6.037 
   82 31.892  5.780  6.072 
   83 31.876  8.726  6.295 
   84 31.933  11.602  6.368 
   85 31.892  14.495  6.374 
   86 31.906  17.404  6.646 
   87 31.893  20.292  6.826 
   88 31.899  23.215  6.824 
   89 34.832  2.845  6.321 
   90 34.786  5.820  6.415 
   91 34.813  8.704  6.509 
   92 34.784  11.606  6.616 
   93 34.828  14.491  6.772 
   94 34.808  17.395  6.863 
   95 34.795  20.307  7.026 
   96 34.834  23.198  7.070 ];
d=data(:,2:4);
%%
del=size(d,1);
r=96;
kk=3;
ABD=[0.09146 ,0.04065,2.971];
B=[d(:,1),d(:,2),ones(del,1)];
nn=zeros(3);

ABD2=[100,100,100];

while max(abs(ABD-ABD2))>1e-6
    u=ABD(1)*d(:,1)+ABD(2)*d(:,2)+d(:,3)+ABD(3);

    AT=zeros(del,3);
    At=[];
    for n=1:del
        AT1=AT;
        AT1(n,:)=[ABD(1),ABD(2),1];
        At=[At,AT1];
    end

    N=[At*At',B;B',nn];
    n=[u;nn(:,1)];
    y=-inv(N)*n;
    ABD2=ABD;
    ABD=ABD+y(end-2:end)';
end

k=y(1:end-3);
v=At'*k;

%               r  k
s0=sqrt((v'*v)/(r-kk));
Qxx=inv(N);
sxi=s0*sqrt(diag(Qxx(end-2:end,end-2:end)*(-1)));